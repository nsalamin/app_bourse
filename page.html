<form id="itemForm">
    <label for="itemId">Num&eacutero vendeur:</label>
    <input type="text" id="Numero vendeur" name="itemId" required>&nbsp;&nbsp;
    <label for="itemPrice">Prix:</label>
    <input type="number" id="Prix" name="itemPrice" required><br><br>
    <button type="submit">Ajoute une vente</button>
</form>

<button id="saveToCSV">Sauvegarder les ventes dans un fichier CSV</button>

<h2>Liste des acheteurs et leurs ventes</h2>
<ul id="itemList"></ul>
<button id="removeLastItem">Enl&egraveve la derniÃ¨re vente</button>

<script>
    // Dictionary to store items
    const items = {};
    // Array to keep track of the order in which items are added
    const itemOrder = [];

    document.getElementById('itemForm').addEventListener('submit', function(event) {
        event.preventDefault();

        // Get item details
        const itemId = document.getElementById('Numero vendeur').value;
        const itemPrice = document.getElementById('Prix').value;

        // Add the price to the array for the given item ID
        if (!items[itemId]) {
            items[itemId] = [];
        }
        items[itemId].push(itemPrice);
        itemOrder.push({ id: itemId, price: itemPrice });

        // Update the item list display
        updateItemList();

        // Clear the form
        document.getElementById('itemForm').reset();
        document.getElementById('Numero vendeur').focus()

        // Send the entire items dictionary to the server to overwrite the CSV file
        updateData();
    });

    document.getElementById('removeLastItem').addEventListener('click', function() {
        removeLastItem();
    });

    document.getElementByID('saveToCSV').addEventListener('click', function() {
        fetch('http://localhost:3000/saveToCSV', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(items)
        })
        .then(response => response.text())
        .then(data => console.log(data))
        .catch(error => console.error('Error:', error));
    });

    function updateItemList() {
        const itemList = document.getElementById('itemList');
        itemList.innerHTML = '';

        // Create a table element
        const table = document.createElement('table');
        table.border = '1';
        table.style.borderCollapse = 'collapse'; // Optional: to collapse borders
        table.style.width = '100%'; // Optional: to make the table full width

        // Create the header row
        const headerRow = document.createElement('tr');
        const headers = ['Vendeur', 'Prix', 'Vente total'];
        headers.forEach(headerText => {
            const header = document.createElement('th');
            header.textContent = headerText;
            header.style.padding = '8px'; // Add padding
            headerRow.appendChild(header);
        });
        table.appendChild(headerRow);

        // Display all items in the dictionary
        Object.entries(items).forEach(([id, prices]) => {
            const row = document.createElement('tr');

            // Create and append the ID cell
            const idCell = document.createElement('td');
            idCell.textContent = id;
            idCell.style.padding = '8px'; // Add padding
            row.appendChild(idCell);

            // Create and append the Prices cell
            const pricesCell = document.createElement('td');
            pricesCell.textContent = prices.join(', ');
            pricesCell.style.padding = '8px'; // Add padding
            row.appendChild(pricesCell);

            // Create and append the Total cell
            const totalCell = document.createElement('td');
            totalCell.textContent = prices.reduce((acc, price) => acc + parseFloat(price), 0);
            totalCell.style.padding = '8px'; // Add padding
            row.appendChild(totalCell);

            table.appendChild(row);
        });

        // Append the table to the itemList element
        itemList.appendChild(table);
    }

    function removeLastItem() {
        if (itemOrder.length > 0) {
            // Remove the last item from the order array
            const lastItem = itemOrder.pop();
            const { id, price } = lastItem;

            // Remove the price from the dictionary
            const priceIndex = items[id].indexOf(price);
            if (priceIndex > -1) {
                items[id].splice(priceIndex, 1);
                if (items[id].length === 0) {
                    delete items[id];
                }
            }

            // Update the item list display
            updateItemList();

            // Send the entire items dictionary to the server to overwrite the CSV file
            updateData();
        }
    }

    function updateData() {
        fetch('http://localhost:3000/updateDB', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(items)
        })
        .then(response => response.text())
        .then(data => console.log(data))
        .catch(error => console.error('Error:', error));
    }
</script>